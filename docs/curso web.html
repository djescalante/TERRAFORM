<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curso Interactivo de Terraform con AWS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Roboto+Mono:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .tab-button.active { @apply bg-indigo-600 text-white shadow-lg; }
        .code-editor { font-family: 'Roboto Mono', monospace; font-size: 0.85rem; }
    </style>
</head>
<body class="p-4 md:p-8 flex justify-center">
    <div id="app" class="w-full max-w-6xl bg-white rounded-xl shadow-2xl overflow-hidden">
        <header class="bg-indigo-700 p-6">
            <h1 class="text-3xl font-extrabold text-white">Guía Interactiva: Terraform y AWS</h1>
            <p class="text-indigo-200 mt-1">Simulación paso a paso del flujo de trabajo de Infraestructura como Código (IaC).</p>
        </header>

        <!-- Navegación de Pestañas -->
        <div id="tabs" class="flex flex-wrap p-4 border-b border-gray-200 bg-gray-50">
            <!-- Los botones de las pestañas se generan dinámicamente -->
        </div>

        <div class="p-6">
            <h2 id="module-title" class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2"></h2>
            
            <!-- Contenedor Principal: Consola y Código -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Columna de Código (Editor) -->
                <div class="bg-gray-800 rounded-xl shadow-inner h-96 flex flex-col">
                    <div class="flex justify-between items-center p-3 bg-gray-900 rounded-t-xl border-b border-gray-700">
                        <span class="text-sm text-yellow-400 font-mono">Código HCL: main.tf</span>
                        <span id="current-step-code" class="text-xs text-gray-400">Paso 1: Código</span>
                    </div>
                    <pre id="hcl-code" class="code-editor text-gray-50 overflow-auto flex-grow p-4"></pre>
                </div>

                <!-- Columna de Consola (Comandos) -->
                <div class="bg-gray-100 rounded-xl shadow-md h-96 flex flex-col">
                    <div class="flex justify-between items-center p-3 bg-gray-300 rounded-t-xl border-b border-gray-400">
                        <span class="text-sm text-gray-700 font-mono">Consola Interactiva</span>
                    </div>
                    <div class="flex-grow overflow-y-auto p-4 space-y-2">
                        <div id="console-output" class="code-editor text-gray-800 whitespace-pre-wrap"></div>
                    </div>
                    
                    <!-- Área de Comandos y Botón -->
                    <div class="p-3 border-t border-gray-300 bg-white rounded-b-xl flex items-center">
                        <span class="text-indigo-600 font-bold mr-2">$</span>
                        <input type="text" id="command-input" class="flex-grow font-mono text-sm border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Escribe tu comando o presiona 'Siguiente Paso'" disabled>
                        <button id="next-step-button" class="ml-3 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 transform hover:scale-105" onclick="nextStep()">Siguiente Paso</button>
                    </div>
                </div>
            </div>
            
            <!-- Barra de Progreso -->
            <div class="mt-6">
                <div class="flex justify-between mb-1">
                    <span class="text-base font-medium text-indigo-700">Progreso del Flujo de Terraform</span>
                    <span id="progress-text" class="text-sm font-medium text-indigo-700">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Definición de Módulos del Curso
        const modules = {
            's3-simple': {
                title: "1. S3 Bucket (Simple)",
                steps: [
                    { cmd: "Revisar Código", output: "// Revisa la configuración HCL a la derecha.", hcl: `
resource "aws_s3_bucket" "my_bucket" {
  bucket = "mi-bucket-unico-curso-terraform"
  tags = {
    Name        = "CursoSimpleBucket"
    Environment = "Dev"
  }
}
`},
                    { cmd: "terraform init", output: "Inicializando backend...\nDescargando proveedores...\n\nTerraform ha sido inicializado exitosamente.", hcl: null },
                    { cmd: "terraform plan", output: "Plan: 1 para añadir, 0 para cambiar, 0 para destruir.\n\nEl plan de ejecución ha sido generado y no necesita aprobación. Los recursos serán creados.", hcl: null },
                    { cmd: "terraform apply", output: "Aplicando cambios. ¡Esto puede tardar unos minutos!\n\naws_s3_bucket.my_bucket: Creando...\naws_s3_bucket.my_bucket: Creación completa en 1.5s.\n\nAplicación terminada. Recursos: 1 añadidos, 0 cambiados, 0 destruidos.", hcl: null },
                    { cmd: "terraform destroy", output: "aws_s3_bucket.my_bucket: Destruyendo...\naws_s3_bucket.my_bucket: Destrucción completa en 1.0s.\n\nDestrucción terminada. Recursos: 0 añadidos, 0 cambiados, 1 destruidos.", hcl: null },
                ]
            },
            'ec2-simple': {
                title: "2. EC2 Instance (Simple)",
                steps: [
                    { cmd: "Revisar Código", output: "// Revisa la configuración HCL a la derecha.", hcl: `
resource "aws_instance" "my_instance" {
  ami           = "ami-0abcdef1234567890" # AMI de ejemplo
  instance_type = "t2.micro"
  tags = {
    Name = "SimpleEC2Server"
  }
}
`},
                    { cmd: "terraform init", output: "Inicializando backend...\nDescargando proveedores...\n\nTerraform ha sido inicializado exitosamente.", hcl: null },
                    { cmd: "terraform plan", output: "Plan: 1 para añadir, 0 para cambiar, 0 para destruir.", hcl: null },
                    { cmd: "terraform apply", output: "Aplicando cambios. ¡Esto puede tardar unos minutos!\n\naws_instance.my_instance: Creando...\naws_instance.my_instance: Creación completa en 15s.\n\nAplicación terminada. Recursos: 1 añadidos, 0 cambiados, 0 destruidos.", hcl: null },
                    { cmd: "terraform destroy", output: "aws_instance.my_instance: Destruyendo...\naws_instance.my_instance: Destrucción completa en 10s.\n\nDestrucción terminada. Recursos: 0 añadidos, 0 cambiados, 1 destruidos.", hcl: null },
                ]
            },
            'lambda': {
                title: "3. Lambda Function & IAM",
                steps: [
                    { cmd: "Revisar Código", output: "// Revisa la configuración HCL a la derecha. (Incluye IAM Role)", hcl: `
resource "aws_iam_role" "lambda_exec" {
  name = "lambda_role_curso"
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Action = "sts:AssumeRole",
      Effect = "Allow",
      Principal = {
        Service = "lambda.amazonaws.com"
      }
    }]
  })
}

resource "aws_lambda_function" "test_lambda" {
  filename         = "lambda_function_payload.zip"
  function_name    = "curso_lambda_func"
  role             = aws_iam_role.lambda_exec.arn
  handler          = "index.handler"
  runtime          = "nodejs18.x"
}
`},
                    { cmd: "terraform init", output: "Inicializando backend...\nDescargando proveedores (aws, archive)...\n\nTerraform ha sido inicializado exitosamente.", hcl: null },
                    { cmd: "terraform plan", output: "Plan: 2 para añadir, 0 para cambiar, 0 para destruir. (IAM Role y Lambda)", hcl: null },
                    { cmd: "terraform apply", output: "Aplicando cambios. Esto puede tardar unos minutos...\n\naws_iam_role.lambda_exec: Creando...\naws_lambda_function.test_lambda: Creando...\n...Creación completa en 8s.\n\nAplicación terminada. Recursos: 2 añadidos, 0 cambiados, 0 destruidos.", hcl: null },
                    { cmd: "terraform destroy", output: "Destruyendo 2 recursos...\naws_lambda_function.test_lambda: Destruyendo...\naws_iam_role.lambda_exec: Destruyendo...\n\nDestrucción terminada. Recursos: 0 añadidos, 0 cambiados, 2 destruidos.", hcl: null },
                ]
            },
            'eb': {
                title: "4. Elastic Beanstalk Application",
                steps: [
                    { cmd: "Revisar Código", output: "// Revisa la configuración HCL a la derecha.", hcl: `
resource "aws_elastic_beanstalk_application" "my_app" {
  name        = "CursoTerraformApp"
  description = "Aplicación Beanstalk de ejemplo."
}

resource "aws_elastic_beanstalk_environment" "my_env" {
  name                = "curso-terraform-env"
  application         = aws_elastic_beanstalk_application.my_app.name
  solution_stack_name = "64bit Amazon Linux 2 v3.4.19 running Docker"
}
`},
                    { cmd: "terraform init", output: "Inicializando backend...\nDescargando proveedores...\n\nTerraform ha sido inicializado exitosamente.", hcl: null },
                    { cmd: "terraform plan", output: "Plan: 2 para añadir, 0 para cambiar, 0 para destruir. (Aplicación y Entorno)", hcl: null },
                    { cmd: "terraform apply", output: "Aplicando cambios. Esto tomará varios minutos...\n\naws_elastic_beanstalk_application.my_app: Creando...\naws_elastic_beanstalk_environment.my_env: Creando...\n...Creación completa en 180s.\n\nAplicación terminada. Recursos: 2 añadidos, 0 cambiados, 0 destruidos.", hcl: null },
                    { cmd: "terraform destroy", output: "Destruyendo 2 recursos...\naws_elastic_beanstalk_environment.my_env: Destruyendo...\naws_elastic_beanstalk_application.my_app: Destruyendo...\n\nDestrucción terminada. Recursos: 0 añadidos, 0 cambiados, 2 destruidos.", hcl: null },
                ]
            },
            'nginx-advanced': {
                title: "5. EC2 NGINX (Avanzado)",
                steps: [
                    { cmd: "Revisar Código", output: "// Revisa la configuración HCL a la derecha. (SG, Key Pair, User Data y Output)", hcl: `
resource "aws_security_group" "nginx_sg" {
  name        = "nginx-sg-curso"
  description = "Permite tráfico HTTP y SSH."
  
  ingress { from_port = 22; to_port = 22; protocol = "tcp"; cidr_blocks = ["0.0.0.0/0"] }
  ingress { from_port = 80; to_port = 80; protocol = "tcp"; cidr_blocks = ["0.0.0.0/0"] }
  
  egress { from_port = 0; to_port = 0; protocol = "-1"; cidr_blocks = ["0.0.0.0/0"] }
}

resource "aws_key_pair" "deployer" {
  key_name   = "deployer-key"
  public_key = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC8..." 
}

resource "aws_instance" "nginx_server" {
  ami             = "ami-0abcdef1234567890" 
  instance_type   = "t2.micro"
  key_name        = aws_key_pair.deployer.key_name
  security_groups = [aws_security_group.nginx_sg.name]

  user_data = <<-EOF
              #!/bin/bash
              sudo yum update -y
              sudo yum install nginx -y
              sudo systemctl start nginx
              EOF

  tags = {
    Name = "NGINX-WebServer"
  }
}

output "public_ip" {
  value = aws_instance.nginx_server.public_ip
}
`},
                    { cmd: "terraform init", output: "Inicializando backend...\nDescargando proveedores...\n\nTerraform ha sido inicializado exitosamente.", hcl: null },
                    { cmd: "terraform plan", output: "Plan: 3 para añadir, 0 para cambiar, 0 para destruir. (Key Pair, SG, Instance)\n\nOutputs:\n  public_ip = (known after apply)", hcl: null },
                    { cmd: "terraform apply", output: "Aplicando cambios. Esto puede tardar varios minutos...\n\naws_key_pair.deployer: Creando...\naws_security_group.nginx_sg: Creando...\naws_instance.nginx_server: Creando...\n...Creación completa en 20s.\n\nOutputs:\n  public_ip = \"18.21.34.123\"\n\nAplicación terminada. Recursos: 3 añadidos, 0 cambiados, 0 destruidos.", hcl: null },
                    { cmd: "terraform destroy", output: "Destruyendo 3 recursos...\naws_instance.nginx_server: Destruyendo...\naws_security_group.nginx_sg: Destruyendo...\naws_key_pair.deployer: Destruyendo...\n\nDestrucción terminada. Recursos: 0 añadidos, 0 cambiados, 3 destruidos.", hcl: null },
                ]
            },
            's3-static-site-advanced': {
                title: "6. S3 Static Site (Avanzado)",
                steps: [
                    { cmd: "Revisar Código", output: "// Revisa la configuración HCL a la derecha. (Website Config, Policy y Output)", hcl: `
resource "aws_s3_bucket" "static_site" {
  bucket = "mi-sitio-estatico-avanzado"
  acl    = "public-read"
  
  website {
    index_document = "index.html"
    error_document = "404.html"
  }
  
  tags = {
    Environment = "Prod"
    Purpose     = "StaticWebsite"
  }
}

data "aws_iam_policy_document" "allow_public_access" {
  statement {
    principals { type = "*"; identifiers = ["*"] }
    actions   = ["s3:GetObject"]
    resources = ["\${aws_s3_bucket.static_site.arn}/*"]
  }
}

resource "aws_s3_bucket_policy" "allow_public_read" {
  bucket = aws_s3_bucket.static_site.id
  policy = data.aws_iam_policy_document.allow_public_access.json
}

output "website_endpoint" {
  value = aws_s3_bucket.static_site.website_endpoint
}
`},
                    { cmd: "terraform init", output: "Inicializando backend...\nDescargando proveedores...\n\nTerraform ha sido inicializado exitosamente.", hcl: null },
                    { cmd: "terraform plan", output: "Plan: 2 para añadir, 0 para cambiar, 0 para destruir. (Bucket y Policy)\n\nOutputs:\n  website_endpoint = (known after apply)", hcl: null },
                    { cmd: "terraform apply", output: "Aplicando cambios. Esto puede tardar unos segundos...\n\naws_s3_bucket.static_site: Creando...\naws_s3_bucket_policy.allow_public_read: Creando...\n...Creación completa en 2s.\n\nOutputs:\n  website_endpoint = \"mi-sitio-estatico-avanzado.s3-website-us-east-1.amazonaws.com\"\n\nAplicación terminada. Recursos: 2 añadidos, 0 cambiados, 0 destruidos.", hcl: null },
                    { cmd: "terraform destroy", output: "Destruyendo 2 recursos...\naws_s3_bucket_policy.allow_public_read: Destruyendo...\naws_s3_bucket.static_site: Destruyendo...\n\nDestrucción terminada. Recursos: 0 añadidos, 0 cambiados, 2 destruidos.", hcl: null },
                ]
            }
        };

        let currentModuleKey = 's3-simple';
        let currentStepIndex = 0;
        let moduleKeys = Object.keys(modules);
        
        const hclCodeElement = document.getElementById('hcl-code');
        const consoleOutputElement = document.getElementById('console-output');
        const commandInputElement = document.getElementById('command-input');
        const nextStepButton = document.getElementById('next-step-button');
        const moduleTitleElement = document.getElementById('module-title');
        const currentStepCodeElement = document.getElementById('current-step-code');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const tabsContainer = document.getElementById('tabs');


        /**
         * Inicializa la interfaz y carga el primer módulo.
         */
        function initializeUI() {
            renderTabs();
            loadModule(currentModuleKey);

            // Permitir que Enter active el botón
            commandInputElement.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    nextStepButton.click();
                }
            });
        }

        /**
         * Renderiza los botones de las pestañas.
         */
        function renderTabs() {
            tabsContainer.innerHTML = '';
            moduleKeys.forEach(key => {
                const module = modules[key];
                const button = document.createElement('button');
                button.textContent = module.title;
                button.className = 'tab-button px-4 py-2 mr-2 mb-2 rounded-lg font-medium transition duration-150 ' + 
                                   'hover:bg-indigo-100 hover:text-indigo-800 text-indigo-700 bg-white border border-gray-300';
                button.onclick = () => loadModule(key);
                tabsContainer.appendChild(button);
            });
        }

        /**
         * Carga los datos y el estado para un módulo específico.
         * @param {string} key - La clave del módulo a cargar.
         */
        function loadModule(key) {
            currentModuleKey = key;
            currentStepIndex = 0;

            // Actualizar botones de pestañas
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(modules[key].title)) {
                    btn.classList.add('active');
                }
            });

            moduleTitleElement.textContent = modules[key].title;
            updateUI();
        }

        /**
         * Avanza al siguiente paso de Terraform (o destruye).
         */
        function nextStep() {
            if (currentStepIndex >= modules[currentModuleKey].steps.length) {
                // Si el curso ha terminado, reiniciamos o destruimos (simulado)
                loadModule(currentModuleKey);
                return;
            }

            currentStepIndex++;
            updateUI();
        }

        /**
         * Actualiza todos los elementos de la interfaz de usuario.
         */
        function updateUI() {
            const module = modules[currentModuleKey];
            const currentStep = module.steps[currentStepIndex];
            const previousStep = module.steps[currentStepIndex - 1] || { cmd: "Inicio", output: "Bienvenido a la simulación interactiva de Terraform. Selecciona un módulo y presiona 'Siguiente Paso'." };

            // 1. Consola (Salida)
            let newOutput = consoleOutputElement.textContent + 
                            `\n\n$ ${previousStep.cmd}\n${currentStep.output}`;
            consoleOutputElement.textContent = newOutput.trim();
            consoleOutputElement.scrollTop = consoleOutputElement.scrollHeight; // Scroll al final

            // 2. Código HCL (Visibilidad)
            if (currentStep.hcl !== null) {
                hclCodeElement.textContent = currentStep.hcl.trim();
            }

            // 3. Barra de Progreso y Estado
            const totalSteps = module.steps.length;
            const percentage = Math.round((currentStepIndex / totalSteps) * 100);
            
            progressBar.style.width = percentage + '%';
            progressText.textContent = `${percentage}%`;
            currentStepCodeElement.textContent = `Paso ${currentStepIndex + 1}: ${currentStep.cmd}`;

            // 4. Botón y Título
            if (currentStepIndex >= totalSteps) {
                nextStepButton.textContent = "Reiniciar Módulo";
                commandInputElement.placeholder = "Módulo Terminado.";
                commandInputElement.disabled = true;
                currentStepCodeElement.textContent = "¡COMPLETADO!";
            } else {
                nextStepButton.textContent = currentStepIndex === 0 ? "Revisar Código" : "Ejecutar " + module.steps[currentStepIndex].cmd;
                commandInputElement.placeholder = `Próximo comando: ${module.steps[currentStepIndex].cmd}`;
                commandInputElement.disabled = true;
            }
        }

        // Inicializar al cargar la ventana
        window.onload = initializeUI;
    </script>
</body>
</html>
