<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curso Interactivo de Terraform con AWS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Roboto+Mono:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .tab-button.active { @apply bg-indigo-600 text-white shadow-lg; }
        .code-editor { font-family: 'Roboto Mono', monospace; font-size: 0.85rem; }
        .file-tab.active { @apply bg-gray-700 text-white; }
        .file-tab { @apply px-3 py-1 text-xs text-gray-400 bg-gray-800 rounded-t-lg cursor-pointer transition duration-150; }
    </style>
</head>
<body class="p-4 md:p-8 flex justify-center">
    <div id="app" class="w-full max-w-6xl bg-white rounded-xl shadow-2xl overflow-hidden">
        <header class="bg-indigo-700 p-6">
            <h1 class="text-3xl font-extrabold text-white">Guía Interactiva: Terraform y AWS</h1>
            <p class="text-indigo-200 mt-1">Simulación paso a paso del flujo de trabajo de Infraestructura como Código (IaC).</p>
        </header>

        <!-- Navegación de Pestañas de Módulos -->
        <div id="tabs" class="flex flex-wrap p-4 border-b border-gray-200 bg-gray-50">
            <!-- Los botones de las pestañas se generan dinámicamente -->
        </div>

        <div class="p-6">
            <h2 id="module-title" class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2"></h2>
            
            <!-- Contenedor Principal: Consola y Código -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Columna de Código (Editor) -->
                <div class="bg-gray-800 rounded-xl shadow-inner h-96 flex flex-col">
                    <div class="flex justify-start items-end p-0 bg-gray-900 rounded-t-xl border-b border-gray-700">
                        <!-- Pestañas de Archivos -->
                        <div id="file-tabs" class="flex">
                            <span class="file-tab active" data-file="main.tf">main.tf</span>
                            <span class="file-tab" data-file="provider.tf">provider.tf</span>
                        </div>
                        <span id="current-step-code" class="text-xs text-gray-400 ml-auto p-2">Paso 1: Código</span>
                    </div>
                    <pre id="hcl-code" class="code-editor text-gray-50 overflow-auto flex-grow p-4"></pre>
                </div>

                <!-- Columna de Consola (Comandos) -->
                <div class="bg-gray-100 rounded-xl shadow-md h-96 flex flex-col">
                    <div class="flex justify-between items-center p-3 bg-gray-300 rounded-t-xl border-b border-gray-400">
                        <span class="text-sm text-gray-700 font-mono">Consola Interactiva</span>
                    </div>
                    <div class="flex-grow overflow-y-auto p-4 space-y-2">
                        <div id="console-output" class="code-editor text-gray-800 whitespace-pre-wrap"></div>
                    </div>
                    
                    <!-- Área de Comandos y Botón -->
                    <div class="p-3 border-t border-gray-300 bg-white rounded-b-xl flex items-center">
                        <span class="text-indigo-600 font-bold mr-2">$</span>
                        <input type="text" id="command-input" class="flex-grow font-mono text-sm border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Escribe tu comando o presiona 'Siguiente Paso'" disabled>
                        <!-- Se eliminó el onclick inline para usar el listener de JS -->
                        <button id="next-step-button" class="ml-3 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 transform hover:scale-105">Siguiente Paso</button> 
                    </div>
                </div>
            </div>
            
            <!-- Barra de Progreso -->
            <div class="mt-6">
                <div class="flex justify-between mb-1">
                    <span class="text-base font-medium text-indigo-700">Progreso del Flujo de Terraform</span>
                    <span id="progress-text" class="text-sm font-medium text-indigo-700">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Contenido del archivo de proveedor para todos los módulos
        const providerHCL = `
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  # Definimos la región de AWS a utilizar
  region = "us-east-1"
}
`;


        // Definición de Módulos del Curso
        const modules = {
            's3-simple': {
                title: "1. S3 Bucket (Simple)",
                steps: [
                    { cmd: "Revisar Código", output: "// Revisa la configuración HCL en 'main.tf' y el proveedor en 'provider.tf'.", main_hcl: `
resource "aws_s3_bucket" "my_bucket" {
  bucket = "mi-bucket-unico-curso-terraform"
  tags = {
    Name        = "CursoSimpleBucket"
    Environment = "Dev"
  }
}
`},
                    { cmd: "terraform init", output: "Inicializando el backend y descargando los proveedores necesarios (hashicorp/aws...)\n\nTerraform ha sido inicializado exitosamente. Ahora podemos ejecutar plan y apply.", main_hcl: null },
                    { cmd: "terraform plan", output: "Refrescando el estado... \nPlan de Ejecución:\n  + create\n\nPlan: 1 para añadir, 0 para cambiar, 0 para destruir.\n\nEl plan es correcto. Listo para aplicar.", main_hcl: null },
                    { cmd: "terraform apply", output: "Aplicando cambios. ¡Esto puede tardar unos minutos!\n\naws_s3_bucket.my_bucket: Creando...\naws_s3_bucket.my_bucket: Creación completa en 1.5s.\n\nAplicación terminada. Recursos: 1 añadidos, 0 cambiados, 0 destruidos.", main_hcl: null },
                    { cmd: "terraform destroy", output: "Plan de Destrucción: 1 para destruir.\n\naws_s3_bucket.my_bucket: Destruyendo...\naws_s3_bucket.my_bucket: Destrucción completa en 1.0s.\n\nDestrucción terminada. Recursos: 0 añadidos, 0 cambiados, 1 destruidos.", main_hcl: null },
                ]
            },
            'ec2-simple': {
                title: "2. EC2 Instance (Simple)",
                steps: [
                    { cmd: "Revisar Código", output: "// Revisa la configuración HCL en 'main.tf' y el proveedor en 'provider.tf'.", main_hcl: `
resource "aws_instance" "my_instance" {
  ami           = "ami-0abcdef1234567890" # AMI de ejemplo
  instance_type = "t2.micro"
  tags = {
    Name = "SimpleEC2Server"
  }
}
`},
                    { cmd: "terraform init", output: "Inicializando el backend y descargando los proveedores necesarios (hashicorp/aws...)\n\nTerraform ha sido inicializado exitosamente. Ahora podemos ejecutar plan y apply.", main_hcl: null },
                    { cmd: "terraform plan", output: "Plan: 1 para añadir, 0 para cambiar, 0 para destruir. (Se creará una instancia t2.micro)", main_hcl: null },
                    { cmd: "terraform apply", output: "Aplicando cambios. ¡Esto puede tardar unos minutos!\n\naws_instance.my_instance: Creando...\naws_instance.my_instance: Creación completa en 15s.\n\nAplicación terminada. Recursos: 1 añadidos, 0 cambiados, 0 destruidos.", main_hcl: null },
                    { cmd: "terraform destroy", output: "Destruyendo 1 recurso...\naws_instance.my_instance: Destruyendo...\naws_instance.my_instance: Destrucción completa en 10s.\n\nDestrucción terminada. Recursos: 0 añadidos, 0 cambiados, 1 destruidos.", main_hcl: null },
                ]
            },
            'lambda': {
                title: "3. Lambda Function & IAM",
                steps: [
                    { cmd: "Revisar Código", output: "// Revisa la configuración HCL en 'main.tf' y el proveedor en 'provider.tf'. (Se requiere el rol IAM para la función Lambda)", main_hcl: `
resource "aws_iam_role" "lambda_exec" {
  name = "lambda_role_curso"
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Action = "sts:AssumeRole",
      Effect = "Allow",
      Principal = {
        Service = "lambda.amazonaws.com"
      }
    }]
  })
}

resource "aws_lambda_function" "test_lambda" {
  filename         = "lambda_function_payload.zip" # Archivo de código binario
  function_name    = "curso_lambda_func"
  role             = aws_iam_role.lambda_exec.arn
  handler          = "index.handler"
  runtime          = "nodejs18.x"
}
`},
                    { cmd: "terraform init", output: "Inicializando el backend y descargando los proveedores necesarios (hashicorp/aws, hashicorp/archive...)\n\nTerraform ha sido inicializado exitosamente.", main_hcl: null },
                    { cmd: "terraform plan", output: "Plan: 2 para añadir, 0 para cambiar, 0 para destruir. (IAM Role y Lambda Function)", main_hcl: null },
                    { cmd: "terraform apply", output: "Aplicando cambios. Esto puede tardar unos minutos...\n\naws_iam_role.lambda_exec: Creando...\naws_lambda_function.test_lambda: Creando...\n...Creación completa en 8s.\n\nAplicación terminada. Recursos: 2 añadidos, 0 cambiados, 0 destruidos.", main_hcl: null },
                    { cmd: "terraform destroy", output: "Destruyendo 2 recursos...\naws_lambda_function.test_lambda: Destruyendo...\naws_iam_role.lambda_exec: Destruyendo...\n\nDestrucción terminada. Recursos: 0 añadidos, 0 cambiados, 2 destruidos.", main_hcl: null },
                ]
            },
            'eb': {
                title: "4. Elastic Beanstalk Application",
                steps: [
                    { cmd: "Revisar Código", output: "// Revisa la configuración HCL en 'main.tf' y el proveedor en 'provider.tf'.", main_hcl: `
resource "aws_elastic_beanstalk_application" "my_app" {
  name        = "CursoTerraformApp"
  description = "Aplicación Beanstalk de ejemplo."
}

resource "aws_elastic_beanstalk_environment" "my_env" {
  name                = "curso-terraform-env"
  application         = aws_elastic_beanstalk_application.my_app.name
  solution_stack_name = "64bit Amazon Linux 2 v3.4.19 running Docker"
}
`},
                    { cmd: "terraform init", output: "Inicializando el backend y descargando los proveedores necesarios (hashicorp/aws...)\n\nTerraform ha sido inicializado exitosamente.", main_hcl: null },
                    { cmd: "terraform plan", output: "Plan: 2 para añadir, 0 para cambiar, 0 para destruir. (Aplicación y Entorno Beanstalk)", main_hcl: null },
                    { cmd: "terraform apply", output: "Aplicando cambios. Esto tomará varios minutos...\n\naws_elastic_beanstalk_application.my_app: Creando...\naws_elastic_beanstalk_environment.my_env: Creando...\n...Creación completa en 180s.\n\nAplicación terminada. Recursos: 2 añadidos, 0 cambiados, 0 destruidos.", main_hcl: null },
                    { cmd: "terraform destroy", output: "Destruyendo 2 recursos...\naws_elastic_beanstalk_environment.my_env: Destruyendo...\naws_elastic_beanstalk_application.my_app: Destruyendo...\n\nDestrucción terminada. Recursos: 0 añadidos, 0 cambiados, 2 destruidos.", main_hcl: null },
                ]
            },
            'nginx-advanced': {
                title: "5. EC2 NGINX (Avanzado)",
                steps: [
                    { cmd: "Revisar Código", output: "// Revisa la configuración HCL en 'main.tf' y el proveedor en 'provider.tf'. (Configura SG, Key Pair y User Data para NGINX)", main_hcl: `
resource "aws_security_group" "nginx_sg" {
  name        = "nginx-sg-curso"
  description = "Permite tráfico HTTP (80) y SSH (22) desde cualquier IP (0.0.0.0/0)."
  
  ingress { from_port = 22; to_port = 22; protocol = "tcp"; cidr_blocks = ["0.0.0.0/0"] }
  ingress { from_port = 80; to_port = 80; protocol = "tcp"; cidr_blocks = ["0.0.0.0/0"] }
  
  egress { from_port = 0; to_port = 0; protocol = "-1"; cidr_blocks = ["0.0.0.0/0"] }
}

resource "aws_key_pair" "deployer" {
  key_name   = "deployer-key"
  # En la práctica, usaríamos una clave generada externamente
  public_key = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC8... generated-key-for-curso" 
}

resource "aws_instance" "nginx_server" {
  ami             = "ami-0abcdef1234567890" 
  instance_type   = "t2.micro"
  key_name        = aws_key_pair.deployer.key_name
  security_groups = [aws_security_group.nginx_sg.name]

  # User Data script para instalar y ejecutar NGINX al inicio
  user_data = <<-EOF
              #!/bin/bash
              sudo yum update -y
              sudo yum install nginx -y
              sudo systemctl start nginx
              EOF

  tags = { Name = "NGINX-WebServer" }
}

output "public_ip" {
  description = "La IP pública del servidor NGINX."
  value       = aws_instance.nginx_server.public_ip
}
`},
                    { cmd: "terraform init", output: "Inicializando el backend y descargando los proveedores necesarios (hashicorp/aws...)\n\nTerraform ha sido inicializado exitosamente.", main_hcl: null },
                    { cmd: "terraform plan", output: "Plan: 3 para añadir, 0 para cambiar, 0 para destruir. (Se crean Key Pair, SG e Instance)\n\nOutputs:\n  public_ip = (known after apply)\n\nEl plan de ejecución ha sido generado.", main_hcl: null },
                    { cmd: "terraform apply", output: "Aplicando cambios. Esto puede tardar varios minutos...\n\naws_key_pair.deployer: Creando...\naws_security_group.nginx_sg: Creando...\naws_instance.nginx_server: Creando...\n...Creación completa en 20s.\n\nOutputs:\n  public_ip = \"18.21.34.123\" (Puedes acceder a esta IP en el puerto 80 para ver NGINX)\n\nAplicación terminada. Recursos: 3 añadidos, 0 cambiados, 0 destruidos.", main_hcl: null },
                    { cmd: "terraform destroy", output: "Destruyendo 3 recursos...\naws_instance.nginx_server: Destruyendo...\naws_security_group.nginx_sg: Destruyendo...\naws_key_pair.deployer: Destruyendo...\n\nDestrucción terminada. Recursos: 0 añadidos, 0 cambiados, 3 destruidos.", main_hcl: null },
                ]
            },
            's3-static-site-advanced': {
                title: "6. S3 Static Site (Avanzado)",
                steps: [
                    { cmd: "Revisar Código", output: "// Revisa la configuración HCL en 'main.tf' y el proveedor en 'provider.tf'. (Configura el hosting estático y la política de acceso público)", main_hcl: `
resource "aws_s3_bucket" "static_site" {
  bucket = "mi-sitio-estatico-avanzado"
  acl    = "public-read" # Permite que los objetos sean leídos públicamente
  
  # Habilita el hosting de sitio web estático
  website {
    index_document = "index.html"
    error_document = "404.html"
  }
  
  tags = {
    Environment = "Prod"
    Purpose     = "StaticWebsite"
  }
}

# Define la política IAM para permitir acceso público a los objetos del bucket
data "aws_iam_policy_document" "allow_public_access" {
  statement {
    principals { type = "*"; identifiers = ["*"] }
    actions   = ["s3:GetObject"]
    resources = ["\${aws_s3_bucket.static_site.arn}/*"]
  }
}

resource "aws_s3_bucket_policy" "allow_public_read" {
  bucket = aws_s3_bucket.static_site.id
  policy = data.aws_iam_policy_document.allow_public_access.json
}

output "website_endpoint" {
  description = "El endpoint público del sitio web estático."
  value       = aws_s3_bucket.static_site.website_endpoint
}
`},
                    { cmd: "terraform init", output: "Inicializando el backend y descargando los proveedores necesarios (hashicorp/aws...)\n\nTerraform ha sido inicializado exitosamente.", main_hcl: null },
                    { cmd: "terraform plan", output: "Plan: 2 para añadir, 0 para cambiar, 0 para destruir. (Se crean Bucket y Policy)\n\nOutputs:\n  website_endpoint = (known after apply)\n\nEl plan es correcto. Listo para aplicar.", main_hcl: null },
                    { cmd: "terraform apply", output: "Aplicando cambios. Esto puede tardar unos segundos...\n\naws_s3_bucket.static_site: Creando...\naws_s3_bucket_policy.allow_public_read: Creando...\n...Creación completa en 2s.\n\nOutputs:\n  website_endpoint = \"mi-sitio-estatico-avanzado.s3-website-us-east-1.amazonaws.com\"\n\nAplicación terminada. Recursos: 2 añadidos, 0 cambiados, 0 destruidos.", main_hcl: null },
                    { cmd: "terraform destroy", output: "Destruyendo 2 recursos...\naws_s3_bucket_policy.allow_public_read: Destruyendo...\naws_s3_bucket.static_site: Destruyendo...\n\nDestrucción terminada. Recursos: 0 añadidos, 0 cambiados, 2 destruidos.", main_hcl: null },
                ]
            }
        };

        let currentModuleKey = 's3-simple';
        let currentStepIndex = 0;
        let activeFile = 'main.tf';
        let moduleKeys = Object.keys(modules);
        
        const hclCodeElement = document.getElementById('hcl-code');
        const consoleOutputElement = document.getElementById('console-output');
        const commandInputElement = document.getElementById('command-input');
        const nextStepButton = document.getElementById('next-step-button');
        const moduleTitleElement = document.getElementById('module-title');
        const currentStepCodeElement = document.getElementById('current-step-code');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const tabsContainer = document.getElementById('tabs');
        const fileTabsContainer = document.getElementById('file-tabs');


        /**
         * Maneja el cambio de pestaña de archivo (main.tf o provider.tf).
         * @param {string} fileKey - La clave del archivo a mostrar.
         */
        function switchFileTab(fileKey) {
            activeFile = fileKey;
            
            // Actualizar botones de archivos
            document.querySelectorAll('.file-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-file') === fileKey) {
                    tab.classList.add('active');
                }
            });
            
            // Re-renderizar el código HCL
            updateCodeDisplay();
        }
        
        /**
         * Renderiza el código HCL según la pestaña de archivo activa.
         */
        function updateCodeDisplay() {
            const module = modules[currentModuleKey];
            const currentStep = module.steps[currentStepIndex];

            if (currentStep.cmd === "Revisar Código") {
                if (activeFile === 'provider.tf') {
                    hclCodeElement.textContent = providerHCL.trim();
                } else {
                    // Muestra main_hcl si no es nulo, de lo contrario lo mantiene sin cambios para no borrar el output
                    if (currentStep.main_hcl !== null) {
                         hclCodeElement.textContent = currentStep.main_hcl.trim();
                    }
                }
            } else if (currentStep.main_hcl !== null) {
                 // Si hay un cambio de código específico, lo muestra
                 hclCodeElement.textContent = currentStep.main_hcl.trim();
            } else {
                // Si estamos en un paso de comando, mantiene el código anterior
                // No actualiza el contenido de hclCodeElement para preservar el último código visible
            }
        }


        /**
         * Inicializa la interfaz y carga el primer módulo.
         */
        function initializeUI() {
            renderTabs();
            loadModule(currentModuleKey);

            // Añadir listeners para las pestañas de archivos
            fileTabsContainer.querySelectorAll('.file-tab').forEach(tab => {
                tab.onclick = () => switchFileTab(tab.getAttribute('data-file'));
            });

            // Permitir que Enter active el botón
            commandInputElement.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    nextStep(); // Llamar directamente a nextStep()
                }
            });
            
            // FIX: Enlazar la función nextStep directamente al botón aquí, en el ámbito del módulo
            nextStepButton.addEventListener('click', nextStep);
        }

        /**
         * Renderiza los botones de las pestañas de Módulos.
         */
        function renderTabs() {
            tabsContainer.innerHTML = '';
            moduleKeys.forEach(key => {
                const module = modules[key];
                const button = document.createElement('button');
                button.textContent = module.title;
                button.className = 'tab-button px-4 py-2 mr-2 mb-2 rounded-lg font-medium transition duration-150 ' + 
                                   'hover:bg-indigo-100 hover:text-indigo-800 text-indigo-700 bg-white border border-gray-300';
                button.onclick = () => loadModule(key);
                tabsContainer.appendChild(button);
            });
        }

        /**
         * Carga los datos y el estado para un módulo específico.
         * @param {string} key - La clave del módulo a cargar.
         */
        function loadModule(key) {
            currentModuleKey = key;
            currentStepIndex = 0;
            activeFile = 'main.tf'; // Resetear a main.tf al cambiar de módulo

            // Actualizar botones de pestañas de módulos
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(modules[key].title)) {
                    btn.classList.add('active');
                }
            });

            // Actualizar botones de pestañas de archivos
            document.querySelectorAll('.file-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-file') === 'main.tf') {
                    tab.classList.add('active');
                }
            });


            moduleTitleElement.textContent = modules[key].title;
            
            // Limpiar consola y resetear código
            consoleOutputElement.textContent = `Bienvenido al módulo: ${modules[currentModuleKey].title}.\n\nComienza el flujo de IaC de Terraform.`;
            
            updateUI();
        }

        /**
         * Avanza al siguiente paso de Terraform (o destruye).
         */
        function nextStep() {
            const module = modules[currentModuleKey];
            const totalSteps = module.steps.length;

            if (currentStepIndex >= totalSteps - 1) {
                // Si el curso ha terminado (después de destroy), reiniciamos
                loadModule(currentModuleKey);
                return;
            }

            currentStepIndex++;
            updateUI();
        }

        /**
         * Actualiza todos los elementos de la interfaz de usuario.
         */
        function updateUI() {
            const module = modules[currentModuleKey];
            const currentStep = module.steps[currentStepIndex];

            // 1. Consola (Salida)
            let newOutput = consoleOutputElement.textContent + 
                            `\n\n$ ${currentStep.cmd}\n${currentStep.output}`;
            consoleOutputElement.textContent = newOutput.trim();
            consoleOutputElement.scrollTop = consoleOutputElement.scrollHeight; // Scroll al final
            
            // 2. Código HCL (Visibilidad)
            updateCodeDisplay();

            // 3. Barra de Progreso y Estado
            const totalSteps = module.steps.length;
            const percentage = Math.round(((currentStepIndex + 1) / totalSteps) * 100);
            
            progressBar.style.width = percentage + '%';
            progressText.textContent = `${percentage}%`;
            currentStepCodeElement.textContent = `Paso ${currentStepIndex + 1}: ${currentStep.cmd}`;

            // 4. Botón y Título
            if (currentStepIndex >= totalSteps - 1) {
                nextStepButton.textContent = "Reiniciar Módulo";
                commandInputElement.placeholder = "Módulo Terminado (Simulado).";
                commandInputElement.disabled = true;
                currentStepCodeElement.textContent = "¡COMPLETADO!";
            } else {
                nextStepButton.textContent = "Ejecutar " + module.steps[currentStepIndex + 1].cmd;
                commandInputElement.placeholder = `Próximo comando: ${module.steps[currentStepIndex + 1].cmd}`;
                commandInputElement.disabled = true;
            }
        }

        // Inicializar al cargar la ventana
        window.onload = initializeUI;
    </script>
</body>
</html>
